name: Playwright

# TODO: run this workflow periodically instead of on every push (?)

on: [push]

jobs:
  playwright-test:
    name: Playwright test
    strategy:
      matrix:
        repository:
          - '@adeira/abacus-backoffice'
          - '@adeira/abacus-kochka'
          - '@adeira/sx-design'
        include:
          - repository: '@adeira/abacus-backoffice'
            source: 'src/abacus-backoffice/**'
            outputDir: 'src/abacus-backoffice/playwright/test-results/'
          - repository: '@adeira/abacus-kochka'
            source: 'src/abacus-kochka/**'
            outputDir: 'src/abacus-kochka/playwright/test-results/'
          - repository: '@adeira/sx-design'
            source: 'src/sx-design/**'
            outputDir: 'src/sx-design/playwright/test-results/'

    runs-on: ubuntu-latest

    steps:
      # https://github.com/actions/checkout
      - uses: actions/checkout@v3.0.2

      # https://github.com/dorny/paths-filter
      - uses: dorny/paths-filter@v2.10.2
        id: paths-filter
        with:
          filters: |
            src: ${{ matrix.source }}

      # https://github.com/actions/setup-node
      - name: Use Node.js 18.x
        if: steps.paths-filter.outputs.src == 'true'
        uses: actions/setup-node@v3.2.0
        with:
          node-version: 18.x
          cache: 'yarn'

      - name: Install Yarn dependencies
        if: steps.paths-filter.outputs.src == 'true'
        run: yarn install --immutable

      - name: Install Playwright
        if: steps.paths-filter.outputs.src == 'true'
        run: yarn workspace ${{ matrix.repository }} playwright install --with-deps

      - name: Run Playwright tests
        if: steps.paths-filter.outputs.src == 'true'
        run: yarn workspace ${{ matrix.repository }} playwright test
        env:
          # See: https://github.com/storybookjs/storybook/issues/16555
          NODE_OPTIONS: --openssl-legacy-provider

      # https://github.com/actions/upload-artifact
      - uses: actions/upload-artifact@v3.1.0
        if: steps.paths-filter.outputs.src == 'true'
        with:
          name: playwright-report (${{ matrix.repository }})
          path: ${{ matrix.outputDir }}
          if-no-files-found: ignore
          retention-days: 30
